"use strict";(this.webpackChunkwyy=this.webpackChunkwyy||[]).push([[113],{784:(e,t,n)=>{n.r(t),n.d(t,{default:()=>V});var r=n(7363),a=n.n(r),c=n(6711),o=n(885),i=n(57),s=n(9638),l=n(2924),u=n.n(l)()("https://enigmatic-forest-38434.herokuapp.com",{autoConnect:!1});u.on("create-success",(function(e){console.log("create-success",e)})),u.on("create-error",(function(e){console.log("create-error",e)})),u.on("join-success",(function(e){console.log("join-success",e)})),u.on("join-info",(function(e){console.log("join-info",e)})),u.on("disconnect-success",(function(e){console.log("disconnect-success",e)})),u.on("private",(function(e){console.log("private",e)})),u.on("publish",(function(e){console.log("publish",e,u)}));const f=u;var d=n(2238),p=n.n(d),m="SOCKET_CONNECT",h="SOCKET_DISCONNECT";console.log((new(p())).getResult());var v=function(e,t){var n=t.type;switch(t.payload,n){case m:return void f.connect();case h:return void f.disconnect();default:return e}},g={socket:f},k=(0,r.createContext)(null);const b=(0,r.memo)((function(){(0,s.T)();var e=(0,i.C)(v,g),t=(0,o.Z)(e,2),n=t[0],l=t[1];return(0,r.useEffect)((function(){return l({type:m}),function(){l({type:h})}}),[]),a().createElement(k.Provider,{value:{lookReducer:n,lookDispatch:l}},a().createElement(c.Outlet,null))}));var y=n(5861),E=n(7757),w=n.n(E),x=(n(1539),n(8674),n(7453)),C=(n(1249),function(e){var t=e.list;return a().createElement("div",{className:"grid grid-cols-3 gap-5"},t.map((function(e){var t=e.uid,n=void 0===t?"":t,r=e.title,o=void 0===r?"":r,i=e.banner,s=void 0===i?"":i,l=e.user,u=void 0===l?"":l;return a().createElement("div",{key:n},a().createElement(c.Link,{to:n},a().createElement("img",{className:"ui_aspect-ratio-16/9 cursor-pointer",loading:"lazy",src:s,alt:""})),a().createElement(c.Link,{to:n,className:"cursor-pointer"},o),a().createElement("div",null,a().createElement(c.Link,{to:"/user/".concat(n)},u)))})))});const O=(0,r.memo)(C),j=(0,r.memo)((function(){var e=(0,r.useState)(20),t=(0,o.Z)(e,2),n=(t[0],t[1],(0,r.useContext)(k)),i=(n.lookReducer.socket,n.lookDispatch,(0,r.useRef)(null)),s=(0,r.useRef)(null),l=(0,r.useState)([]),u=(0,o.Z)(l,2),f=(u[0],u[1],(0,x.useQuery)("look",(0,y.Z)(w().mark((function e(){var t,n;return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("".concat("https://enigmatic-forest-38434.herokuapp.com","/list")).then((function(e){return e.json()}));case 2:return t=e.sent,n=t.data,e.abrupt("return",n);case 5:case"end":return e.stop()}}),e)}))))),d=f.data,p=void 0===d?[]:d;return f.error,f.isLoading,f.isSuccess,f.status,a().createElement("div",{className:"domLook overflow-auto max-h-full flex-auto",ref:i},a().createElement("div",{className:"domLook_header ui_header"},a().createElement("span",{className:"title h1"},"LOOK直播"),a().createElement("span",{className:"text-gray-400 slogan ml-2"},"在这里，看见音乐"),a().createElement(c.Link,{to:"my",className:"ml-2 py-1 px-2 rounded bg-red-500 text-white"},"我的直播"),a().createElement("a",{href:"https://look.163.com/hot",className:"text-gray-400 ml-auto"},"更多 >")),a().createElement("div",{className:"px-8"},a().createElement(O,{list:p}),a().createElement("div",{ref:s})))}));n(7042),n(1038),n(4916),n(2165),n(7941),n(7327),n(5003),n(9337);var N=n(4942),S=(n(8309),n(4747),n(6992),n(189),n(8783),n(3948),n(2526),n(1817),n(4184)),D=n.n(S),R=n(6486);function Z(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return A(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?A(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,o=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){i=!0,c=e},f:function(){try{o||null==n.return||n.return()}finally{if(i)throw c}}}}function A(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var I=n(5671),P=n(3144),L={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:192.158.29.39:3478?transport=udp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"},{urls:"turn:192.158.29.39:3478?transport=tcp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}]},F=function(){function e(t){(0,I.Z)(this,e),(0,N.Z)(this,"candidate",null),(0,N.Z)(this,"id",null);var n=t.iceCandidateCallback,r=t.negotiationneededCallback,a=t.trackCallback;this.pc=new RTCPeerConnection(L),this.iceCandidateCallback=n,this.negotiationneededCallback=r,this.trackCallback=a,this.init()}var t,n,r;return(0,P.Z)(e,[{key:"localDescription",get:function(){return this.pc.localDescription}},{key:"remoteDescription",get:function(){return this.pc.remoteDescription}},{key:"iceCandidate",get:function(){return this.candidate}},{key:"init",value:function(){var e=this;this.pc.onicecandidate=function(t){console.log("pc onicecandidate","id: ",e.id);var n=t.candidate;n&&(e.candidate=n,e.iceCandidateCallback(n))},this.pc.onconnectionstatechange=function(t){console.log("pc onconnectionstatechange",e.pc.connectionState),e.pc.connectionState},this.pc.ondatachannel=function(e){console.log("Data channel is created!"),e.channel.onopen=function(){console.log("Data channel is open and ready to be used.")}},this.pc.onicecandidateerror=function(e){console.log("pc onicecandidateerror"),e.errorCode>=300&&e.errorCode<=699||e.errorCode>=700&&e.errorCode},this.pc.oniceconnectionstatechange=function(t){console.log("pc oniceconnectionstatechange",e.pc.iceConnectionState),"failed"===e.pc.iceConnectionState||"disconnected"===e.pc.iceConnectionState||e.pc.iceConnectionState},this.pc.onicegatheringstatechange=function(t){console.log("pc onicegatheringstatechange",e.pc.iceGatheringState);var n="Unknown";switch(e.pc.iceGatheringState){case"new":case"complete":n="Idle";break;case"gathering":n="Determining route"}console.log("label",n)},this.pc.onnegotiationneeded=function(){var t=(0,y.Z)(w().mark((function t(n){return w().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("pc onnegotiationneeded"),t.prev=1,t.t0=e.pc,t.next=5,e.pc.createOffer();case 5:return t.t1=t.sent,t.next=8,t.t0.setLocalDescription.call(t.t0,t.t1);case 8:e.negotiationneededCallback(e.pc.localDescription),t.next=14;break;case 11:t.prev=11,t.t2=t.catch(1),console.log("onnegotiationneeded error \n",t.t2);case 14:case"end":return t.stop()}}),t,null,[[1,11]])})));return function(e){return t.apply(this,arguments)}}(),this.pc.onsignalingstatechange=function(t){console.log("pc onsignalingstatechange",e.pc.signalingState),e.pc.signalingState},this.pc.ontrack=function(t){e.trackCallback(t)}}},{key:"addTrack",value:function(e,t){this.pc.addTrack(e,t)}},{key:"start",value:(r=(0,y.Z)(w().mark((function e(){var t;return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.pc.createOffer();case 3:return t=e.sent,e.next=6,this.pc.setLocalDescription(t);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),console.log("createOffer error \n",e.t0);case 11:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(){return r.apply(this,arguments)})},{key:"gotDescription",value:(n=(0,y.Z)(w().mark((function e(t){return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.pc.setRemoteDescription(t);case 3:return e.t0=this.pc,e.next=6,this.pc.createAnswer();case 6:return e.t1=e.sent,e.next=9,e.t0.setLocalDescription.call(e.t0,e.t1);case 9:e.next=14;break;case 11:e.prev=11,e.t2=e.catch(0),console.log("createAnswer error \n",e.t2);case 14:case"end":return e.stop()}}),e,this,[[0,11]])}))),function(e){return n.apply(this,arguments)})},{key:"gotIceCandidate",value:(t=(0,y.Z)(w().mark((function e(t){return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.pc.addIceCandidate(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),console.log("addIceCandidate error \n",e.t0);case 8:case"end":return e.stop()}}),e,this,[[0,5]])}))),function(e){return t.apply(this,arguments)})}]),e}();function T(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function M(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?T(Object(n),!0).forEach((function(t){(0,N.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):T(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return G(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?G(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,o=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){i=!0,c=e},f:function(){try{o||null==n.return||n.return()}finally{if(i)throw c}}}}function G(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var q=function(e){var t=e.onClick,n=e.children,r=e.status,c=void 0!==r&&r;return a().createElement("button",{type:"button",className:D()("text-white rounded px-2 h-8 flex-center",c?"bg-red-500":"bg-blue-500"),onClick:t},n)},z=function(e){var t=e.name,n=e.children,r=e.checked,c=e.onChange;return a().createElement("label",{htmlFor:t},a().createElement("input",{type:"checkbox",id:t,name:t,checked:r,onChange:function(){return c(t)}}),n)},K=[{key:"desktop",name:"桌面"},{key:"video",name:"摄像头-画面"},{key:"audio",name:"摄像头-声音"},{key:"face",name:"摄像头-人脸识别"}],Q=[{key:"audioinput",name:"音频输入"},{key:"videoinput",name:"视频输入"}];const U=(0,r.memo)((function(){var e=(0,r.useContext)(k),t=e.lookReducer.socket,n=(e.lookDispatch,function(){var e=(0,r.useState)([]),t=(0,o.Z)(e,2),n=t[0],a=t[1],c=(0,r.useState)([]),i=(0,o.Z)(c,2),s=i[0],l=i[1];return(0,r.useEffect)((function(){(0,y.Z)(w().mark((function e(){var t,n,r,c,o,i;return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,n=[],r=[],c=Z(t),e.prev=6,c.s();case 8:if((o=c.n()).done){e.next=23;break}i=o.value,e.t0=i.kind,e.next="audioinput"===e.t0?13:"videoinput"===e.t0?15:"audiooutput"===e.t0?17:19;break;case 13:return n.push(i),e.abrupt("break",21);case 15:return r.push(i),e.abrupt("break",21);case 17:return console.log("audiooutput: ",i),e.abrupt("break",21);case 19:return console.log("default device"),e.abrupt("break",21);case 21:e.next=8;break;case 23:e.next=28;break;case 25:e.prev=25,e.t1=e.catch(6),c.e(e.t1);case 28:return e.prev=28,c.f(),e.finish(28);case 31:a(n),l(r);case 33:case"end":return e.stop()}}),e,null,[[6,25,28,31]])})))()}),[]),{audioinput:n,videoinput:s}}()),c=(0,i.x)({desktop:!1,audio:!1,video:!1,face:!1}),s=(0,o.Z)(c,2),l=s[0],u=s[1],f=(0,r.useRef)(null),d=(0,r.useRef)(null),p=(0,r.useRef)(new F({iceCandidateCallback:function(e){console.log("emit publish candidate"),t.emit("publish",{to:"337845818",candidate:e})},negotiationneededCallback:function(e){console.log("emit publish localDescription"),t.emit("publish",{to:"337845818",localDescription:e})}})),m=((0,r.useRef)(null),(0,r.useRef)(null)),h=(0,i.x)({desktop:{},user:{}}),v=(0,o.Z)(h,2),g=(v[0],v[1]),b=(0,r.useState)({desktop:null,user:null,mixin:null}),E=(0,o.Z)(b,2),x=E[0],C=E[1],O=(0,r.useRef)(),j=(0,r.useRef)(null),N=(0,r.useRef)(null),S=(0,r.useRef)(null),D=((0,r.useRef)(new FaceDetector),function(e){var t=e.current;return function(e){var n=e.target,r=n.clientWidth,a=n.clientHeight;t.width=r,t.height=a}});(0,r.useEffect)((function(){N.current=m.current.getContext("2d")}),[m]),(0,r.useEffect)((function(){S.current=j.current.getContext("2d")}),[j]);var A=function e(){if(x.desktop){var t=j.current,n=t.width,r=t.height;requestAnimationFrame(e),S.current.drawImage(d.current,0,0,n,r)}},I=function e(){if(x.user){requestAnimationFrame(e);var t=S.current,n=f.current;t.save(),t.scale(-1,1),t.drawImage(n,0,0,-200,200/O.current.aspectRatio),t.restore()}};(0,r.useEffect)((function(){console.log("streams desktop effect"),A()}),[x.desktop]),(0,r.useEffect)((function(){console.log("streams user effect"),I()}),[x.user]);var P=function(e,t){var n=e.kind;g((function(r){var a,c;null!==(c=(a=r[t])[n])&&void 0!==c||(a[n]=new Set),r[t][n].add(e)}))},L=function(){var e=(0,y.Z)(w().mark((function e(){var t,n,r,a,c,o;return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=d.current,e.prev=1,e.next=4,navigator.mediaDevices.getDisplayMedia({audio:!0,video:!0});case 4:n=e.sent,C((function(e){return M(M({},e),{},{desktop:n})})),t.srcObject=n,r=n.getTracks(),a=_(r);try{for(a.s();!(c=a.n()).done;)o=c.value,P(o,"desktop"),p.current.addTrack(o,n)}catch(e){a.e(e)}finally{a.f()}r[0].onended=function(){},e.next=16;break;case 13:e.prev=13,e.t0=e.catch(1),console.log("桌面捕捉",e.t0);case 16:case"end":return e.stop()}}),e,null,[[1,13]])})));return function(){return e.apply(this,arguments)}}(),T=function(){var e=(0,y.Z)(w().mark((function e(){return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.current.start();case 2:t.emit("create",{detail:{title:"6666",user:"337845818",uid:"337845818",banner:"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.jj20.com%2Fup%2Fallimg%2Ftp03%2F1Z9211616415M2-0-lp.jpg&refer=http%3A%2F%2Fimg.jj20.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1642140129&t=1cd7e5653b612ffbe71c1f461c5cb387"}}),L();case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),G=function(){var e=(0,y.Z)(w().mark((function e(n){return w().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.current.gotIceCandidate(n.description);case 2:t.emit("private",{to:n.from,description:p.current.localDescription});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),U=function(e){e.description&&p.current.gotDescription(e.description),e.iceCandidate&&p.current.gotIceCandidate(e.iceCandidate)};(0,r.useEffect)((function(){return t.on("join-success",G),t.on("private",U),function(){t.off("join-success",G),t.off("private",G)}}),[]);var J=(0,r.useCallback)((function(e){u((function(t){var n=(0,R.get)(t,e);(0,R.set)(t,e,!n)}))}),[]);return a().createElement("div",{className:"w-full h-full p-8 overflow-auto"},a().createElement("div",{className:"flex"},a().createElement(q,{onClick:T},"开始捕获并推送"),a().createElement("div",{className:"border ml-auto"},a().createElement("div",{className:"flex flex-col flex-wrap"},K.map((function(e){var t=e.key,n=e.name;return a().createElement(z,{key:t,name:t,onChange:J,checked:l[t]},a().createElement("span",null,n))})),Q.map((function(e){var t=e.key,r=e.name;return a().createElement("div",{key:t},a().createElement("span",null,r),a().createElement("select",{className:"border",disabled:!0},n[t].map((function(e,t){return a().createElement("option",{value:"",key:t},e.label)}))))}))))),a().createElement("div",{className:"flex flex-col"},a().createElement("div",{className:""},a().createElement("video",{className:"w-full",ref:d,autoPlay:!0,playsInline:!0,onLoadedMetadata:D(j)})),a().createElement("hr",null),a().createElement("div",{className:"relative"},a().createElement("video",{className:"w-full",ref:f,autoPlay:!0,playsInline:!0,style:{transform:"scale(-1, 1)"},onLoadedMetadata:D(m)}),a().createElement("canvas",{className:"absolute inset-0 w-full h-full",style:{transform:"scale(-1, 1)"},ref:m}))),a().createElement("hr",null),a().createElement("div",null,a().createElement("canvas",{className:"w-full",ref:j})))})),J=(0,r.memo)((function(){var e=(0,c.useParams)().uid,t=(0,r.useContext)(k),n=t.lookReducer.socket,o=(t.lookDispatch,(0,r.useRef)(new MediaStream),(0,r.useRef)(null)),i=(0,r.useRef)(new F({iceCandidateCallback:function(e){n.emit("private",{to:i.current.id,iceCandidate:e})},negotiationneededCallback:function(e){console.log("重发 description"),n.emit("private",{to:i.current.id,description:e})},trackCallback:function(e){console.log("get track",e),o.current.srcObject=e.streams[0]}})),s=function(e){e.from&&(i.current.id=e.from),e.description&&i.current.gotDescription(e.description),e.iceCandidate&&i.current.gotIceCandidate(e.iceCandidate)};return(0,r.useEffect)((function(){return n.on("private",s),n.on("publish",s),n.emit("join",{detail:{uid:e}}),function(){n.off("join-success",s)}}),[]),a().createElement("div",{className:"p-8 flex"},a().createElement("div",{className:"relative flex-1"},a().createElement("video",{ref:o,className:"w-full",autoPlay:!0,playsInline:!0})),a().createElement("div",{className:"w-1/4 flex flex-col ml-2 border"},a().createElement("div",{className:"flex-1 overflow-auto"}),a().createElement("hr",null),a().createElement("div",{className:""},a().createElement("textarea",{className:"resize-none p-1 h-16 w-full block",placeholder:"say something"}))))})),V=function(){return a().createElement(c.Routes,null,a().createElement(c.Route,{element:a().createElement(b,null)},a().createElement(c.Route,{index:!0,element:a().createElement(j,null)}),a().createElement(c.Route,{path:"my",element:a().createElement(U,null)}),a().createElement(c.Route,{path:":uid",element:a().createElement(J,null)})))}}}]);
//# sourceMappingURL=Look.js.map?version=5d51bdc1