"use strict";(this.webpackChunkwyy=this.webpackChunkwyy||[]).push([[113],{784:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Q});var r=n(7363),o=n.n(r),c=n(6711),a=n(885),i=n(57),l=n(9638),s=n(2924),u=n.n(s)()("https://enigmatic-forest-38434.herokuapp.com",{autoConnect:!1});u.on("create-success",(function(e){console.log(e)})),u.on("create-error",(function(e){console.log(e)})),u.on("join-success",(function(e){console.log(e)})),u.on("disconnect-success",(function(e){console.log(e)})),u.on("list-success",(function(e){console.log(e)}));const f=u;var m="SOCKET_CONNECT",d="SOCKET_DISCONNECT",p="SOCKET_DESKTOP_END",h="SOCKET_USER_START",v="SOCKET_PUSH_END",g=function(e,t){var n=t.type;switch(t.payload,n){case m:return void f.connect();case d:return void f.disconnect();case"SOCKET_DESKTOP_START":case p:case h:case"SOCKET_USER_END":case"SOCKET_PUSH_START":case v:case"SOCKET_JOIN_START":return;default:return e}},y={socket:f},E=(0,r.createContext)(null);const k=(0,r.memo)((function(){(0,l.T)();var e=(0,i.C)(g,y),t=(0,a.Z)(e,2),n=t[0],s=t[1];return(0,r.useEffect)((function(){return s({type:m}),function(){s({type:d})}}),[]),o().createElement(E.Provider,{value:{lookReducer:n,lookDispatch:s}},o().createElement(c.Outlet,null))}));var b=n(5861),w=n(7757),S=n.n(w),C=(n(1539),n(8674),n(7453)),x=(n(1249),function(e){var t=e.list;return o().createElement("div",{className:"grid grid-cols-3 gap-5"},t.map((function(e){var t=e.uid,n=void 0===t?"":t,r=e.title,a=void 0===r?"":r,i=e.banner,l=void 0===i?"":i,s=e.user,u=void 0===s?"":s;return o().createElement("div",{key:n},o().createElement(c.Link,{to:n},o().createElement("img",{className:"ui_aspect-ratio-16/9 cursor-pointer",loading:"lazy",src:l,alt:""})),o().createElement(c.Link,{to:n,className:"cursor-pointer"},a),o().createElement("div",null,o().createElement(c.Link,{to:"/user/".concat(n)},u)))})))});const O=(0,r.memo)(x),N=(0,r.memo)((function(){var e=(0,r.useState)(20),t=(0,a.Z)(e,2),n=(t[0],t[1],(0,r.useContext)(E)),i=(n.lookReducer.socket,n.lookDispatch,(0,r.useRef)(null)),l=(0,r.useRef)(null),s=(0,r.useState)([]),u=(0,a.Z)(s,2),f=(u[0],u[1],(0,C.useQuery)("look",(0,b.Z)(S().mark((function e(){var t,n;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("".concat("https://enigmatic-forest-38434.herokuapp.com","/list")).then((function(e){return e.json()}));case 2:return t=e.sent,n=t.data,e.abrupt("return",n);case 5:case"end":return e.stop()}}),e)}))))),m=f.data,d=void 0===m?[]:m;return f.error,f.isLoading,f.isSuccess,f.status,o().createElement("div",{className:"domLook overflow-auto max-h-full flex-auto",ref:i},o().createElement("div",{className:"domLook_header ui_header"},o().createElement("span",{className:"title h1"},"LOOK直播"),o().createElement("span",{className:"text-gray-400 slogan ml-2"},"在这里，看见音乐"),o().createElement(c.Link,{to:"my",className:"ml-2 py-1 px-2 rounded bg-red-500 text-white"},"我的直播"),o().createElement("a",{href:"https://look.163.com/hot",className:"text-gray-400 ml-auto"},"更多 >")),o().createElement("div",{className:"px-8"},o().createElement(O,{list:d}),o().createElement("div",{ref:l})))}));n(7042),n(1038),n(2165),n(7941),n(7327),n(5003),n(9337);var R=n(4942),j=(n(2772),n(4916),n(4723),n(8309),n(4747),n(6992),n(189),n(8783),n(3948),n(2526),n(1817),n(4184)),T=n.n(j),D=n(6486);function _(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return A(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?A(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,a=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){i=!0,c=e},f:function(){try{a||null==n.return||n.return()}finally{if(i)throw c}}}}function A(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var P=n(5671),Z=n(3144),I={iceServers:[{urls:["stun:stun.xten.com","stun:stun.services.mozilla.com","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}]},L=function(){function e(){(0,P.Z)(this,e),(0,R.Z)(this,"remoteStreams",[]),(0,R.Z)(this,"description",null),this.pc=new RTCPeerConnection(I),this.init()}return(0,Z.Z)(e,[{key:"init",value:function(){var e=this;this.pc.onicecandidate=function(e){console.log("pc onicecandidate"),e.target;var t=e.candidate;t&&new RTCIceCandidate(t)},this.pc.onconnectionstatechange=function(t){console.log("pc onconnectionstatechange"),e.pc.connectionState},this.pc.ondatachannel=function(e){console.log("Data channel is created!"),e.channel.onopen=function(){console.log("Data channel is open and ready to be used.")}},this.pc.onicecandidateerror=function(e){console.log("pc onicecandidateerror"),e.errorCode>=300&&e.errorCode<=699||e.errorCode>=700&&e.errorCode},this.pc.oniceconnectionstatechange=function(t){console.log("pc oniceconnectionstatechange"),"failed"===e.pc.iceConnectionState||"disconnected"===e.pc.iceConnectionState||e.pc.iceConnectionState},this.pc.onicegatheringstatechange=function(){console.log("pc onicegatheringstatechange");var t="Unknown";switch(e.pc.iceGatheringState){case"new":case"complete":t="Idle";break;case"gathering":t="Determining route"}console.log(t)},this.pc.onnegotiationneeded=function(){console.log("pc onnegotiationneeded"),e.pc.createOffer().then((function(t){return console.log("setLocalDescription"),e.pc.setLocalDescription(t)})).then((function(){})).catch((function(e){return console.log(e)}))},this.pc.onsignalingstatechange=function(t){console.log("pc onsignalingstatechange"),e.pc.signalingState},this.pc.ontrack=function(t){e.remoteStreams=t.streams.slice()}}},{key:"addtrack",value:function(e){var t=e.track,n=e.stream;this.pc.addTrack(t,n)}},{key:"start",value:function(){var e=this;this.pc.createOffer().then((function(t){return e.description=t,console.log(t),e.pc.setLocalDescription(t)})).then((function(){console.log(e.pc)})).catch((function(e){console.log("createAnswer error \n",e)}))}},{key:"got",value:function(e){this.pc.setRemoteDescription(e).then((function(){}))}}]),e}();function F(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function K(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?F(Object(n),!0).forEach((function(t){(0,R.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):F(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function U(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return M(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?M(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,a=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){i=!0,c=e},f:function(){try{a||null==n.return||n.return()}finally{if(i)throw c}}}}function M(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var z=function(e){var t=e.onClick,n=e.children,r=e.status,c=void 0!==r&&r;return o().createElement("button",{type:"button",className:T()("text-white rounded px-2 h-8 flex-center",c?"bg-red-500":"bg-blue-500"),onClick:t},n)},q=function(e){var t=e.name,n=e.children,r=e.checked,c=e.onChange;return o().createElement("label",{htmlFor:t},o().createElement("input",{type:"checkbox",id:t,name:t,checked:r,onChange:function(){return c(t)}}),n)},H=[{key:"desktop",name:"桌面"},{key:"video",name:"摄像头-画面"},{key:"audio",name:"摄像头-声音"},{key:"face",name:"摄像头-人脸识别"}],$=[{key:"audioinput",name:"音频输入"},{key:"videoinput",name:"视频输入"}];const G=(0,r.memo)((function(){var e=(0,r.useContext)(E),t=e.lookReducer,n=t.socket,c=(t.pc,e.lookDispatch),l=function(){var e=(0,r.useState)([]),t=(0,a.Z)(e,2),n=t[0],o=t[1],c=(0,r.useState)([]),i=(0,a.Z)(c,2),l=i[0],s=i[1];return(0,r.useEffect)((function(){(0,b.Z)(S().mark((function e(){var t,n,r,c,a,i;return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,n=[],r=[],c=_(t);try{for(c.s();!(a=c.n()).done;)"audioinput"===(i=a.value).kind?n.push(i):"videoinput"===i.kind?r.push(i):console.log("other kind: ",i)}catch(e){c.e(e)}finally{c.f()}o(n),s(r);case 9:case"end":return e.stop()}}),e)})))()}),[]),{audioinput:n,videoinput:l}}(),s=(0,i.x)({desktop:!1,audio:!1,video:!1,face:!1}),u=(0,a.Z)(s,2),f=u[0],m=u[1],d=(0,r.useRef)(null),g=(0,r.useRef)(null),y=(0,r.useRef)(new L),k=((0,r.useRef)(null),(0,r.useRef)(null)),w=(0,i.x)({desktop:{},user:{}}),C=(0,a.Z)(w,2),x=(C[0],C[1]),O=(0,r.useState)({desktop:null,user:null,mixin:null}),N=(0,a.Z)(O,2),R=N[0],j=N[1],T=(0,r.useRef)(),A=(0,r.useRef)(null),P=(0,r.useRef)(null),Z=(0,r.useRef)(null),I=((0,r.useRef)(new FaceDetector),function(){c({type:v,payload:{uid:"337845818"}})});(0,r.useEffect)((function(){return I}),[]);var F=function(e){var t=e.current;return function(e){var n=e.target,r=n.clientWidth,o=n.clientHeight;t.width=r,t.height=o}};(0,r.useEffect)((function(){P.current=k.current.getContext("2d")}),[k]),(0,r.useEffect)((function(){Z.current=A.current.getContext("2d")}),[A]);var M=function e(){if(R.desktop){var t=A.current,n=t.width,r=t.height;requestAnimationFrame(e),Z.current.drawImage(g.current,0,0,n,r)}},G=function e(){if(R.user){requestAnimationFrame(e);var t=Z.current,n=d.current;t.save(),t.scale(-1,1),t.drawImage(n,0,0,-200,200/T.current.aspectRatio),t.restore()}};(0,r.useEffect)((function(){console.log("streams desktop effect"),M()}),[R.desktop]),(0,r.useEffect)((function(){console.log("streams user effect"),G()}),[R.user]);var J=function(e,t){var n=e.kind;x((function(r){var o,c;null!==(c=(o=r[t])[n])&&void 0!==c||(o[n]=new Set),r[t][n].add(e)}))},Q=(0,r.useCallback)((function(e){m((function(t){var n=(0,D.get)(t,e);(0,D.set)(t,e,!n)}))}),[]);return o().createElement("div",{className:"w-full h-full p-8 overflow-auto"},o().createElement("div",{className:"flex"},o().createElement(z,{onClick:function(){var e,t;e=g.current,navigator.mediaDevices.getDisplayMedia({audio:!0,video:!0}).then((function(t){j((function(e){return K(K({},e),{},{desktop:t})})),e.srcObject=t;var n,r=t.getTracks(),o=U(r);try{for(o.s();!(n=o.n()).done;){var a=n.value;c({type:"addtrack",payload:{track:a,stream:t}}),J(a,"desktop")}}catch(e){o.e(e)}finally{o.f()}console.log("desktop tracks",r),r[0].onended=function(){c({type:p})}})).catch((function(e){console.log("桌面捕获",e)})),t=d.current,navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}}}).then((function(e){j((function(t){return K(K({},t),{},{user:e})}));var n,r=U(e.getVideoTracks());try{for(r.s();!(n=r.n()).done;){var o=n.value.getSettings();console.log(o),T.current=o}}catch(e){r.e(e)}finally{r.f()}t.srcObject=e,c({type:h})})).catch((function(e){console.log("摄像头捕获",e)}))}},"开始捕获"),o().createElement(z,{onClick:function(){y.current.start(),n.emit("create",{title:"6666",user:"337845818",uid:"337845818",banner:"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.jj20.com%2Fup%2Fallimg%2Ftp03%2F1Z9211616415M2-0-lp.jpg&refer=http%3A%2F%2Fimg.jj20.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1642140129&t=1cd7e5653b612ffbe71c1f461c5cb387",sdp:y.current.description})}},"推送"),o().createElement("div",{className:"border ml-auto"},o().createElement("div",{className:"flex flex-col flex-wrap"},H.map((function(e){var t=e.key,n=e.name;return o().createElement(q,{key:t,name:t,onChange:Q,checked:f[t]},o().createElement("span",null,n))})),$.map((function(e){var t=e.key,n=e.name;return o().createElement("div",{key:t},o().createElement("span",null,n),o().createElement("select",{className:"border",disabled:!0},l[t].map((function(e,t){return o().createElement("option",{value:"",key:t},e.label)}))))}))))),o().createElement("div",{className:"flex flex-col"},o().createElement("div",{className:""},o().createElement("video",{className:"w-full",ref:g,autoPlay:!0,playsInline:!0,onLoadedMetadata:F(A)})),o().createElement("hr",null),o().createElement("div",{className:"relative"},o().createElement("video",{className:"w-full",ref:d,autoPlay:!0,playsInline:!0,style:{transform:"scale(-1, 1)"},onLoadedMetadata:F(k)}),o().createElement("canvas",{className:"absolute inset-0 w-full h-full",style:{transform:"scale(-1, 1)"},ref:k}))),o().createElement("hr",null),o().createElement("div",null,o().createElement("canvas",{className:"w-full",ref:A})))})),J=(0,r.memo)((function(){(0,c.useParams)().uid;var e=(0,r.useContext)(E),t=e.lookReducer.socket,n=(e.lookDispatch,(0,r.useRef)(null)),a=(0,r.useRef)(new L),i=function(){var e=(0,b.Z)(S().mark((function e(){return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.current){e.next=2;break}return e.abrupt("return");case 2:a.current.start(),t.emit("join",a.current.description);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,r.useEffect)((function(){i()}),[]),(0,r.useEffect)((function(){var e=function(e){console.log("asd",e)};return t.on("join-success",e),function(){t.off("join-success",e)}}),[]),o().createElement("div",{className:"p-8 flex"},o().createElement("div",{className:"relative flex-1"},o().createElement("video",{ref:n,className:"w-full bg-black ui_aspect-ratio-16/9",autoPlay:!0,playsInline:!0}),o().createElement("video",{className:"absolute bottom-0 right-0 w-36 border m-4 ui_aspect-ratio-16/9",autoPlay:!0,playsInline:!0,muted:!0})),o().createElement("div",{className:"w-1/4 flex flex-col ml-2 border"},o().createElement("div",{className:"flex-1 overflow-auto"}),o().createElement("hr",null),o().createElement("div",{className:""},o().createElement("textarea",{className:"resize-none p-1 h-16 w-full block",placeholder:"say something"}))))})),Q=function(){return o().createElement(c.Routes,null,o().createElement(c.Route,{element:o().createElement(k,null)},o().createElement(c.Route,{index:!0,element:o().createElement(N,null)}),o().createElement(c.Route,{path:"my",element:o().createElement(G,null)}),o().createElement(c.Route,{path:":uid",element:o().createElement(J,null)})))}}}]);
//# sourceMappingURL=Look.js.map?version=0bd30fea