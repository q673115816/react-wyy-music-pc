"use strict";(this.webpackChunkwyy=this.webpackChunkwyy||[]).push([[113],{5935:(e,t,n)=>{n.r(t),n.d(t,{default:()=>z});var r=n(7363),a=n.n(r),c=n(6711),o=n(885),s=n(57),u=n(9638),i=n(2924),l=n.n(i)()("https://enigmatic-forest-38434.herokuapp.com",{autoConnect:!1});l.on("create-success",(function(e){console.log(e)})),l.on("create-error",(function(e){console.log(e)})),l.on("join-success",(function(e){console.log(e)})),l.on("disconnect-success",(function(e){console.log(e)})),l.on("list-success",(function(e){console.log(e)}));const f=l;var m="SOCKET_CONNECT",d="SOCKET_DISCONNECT",p="SOCKET_DESKTOP_START",v="SOCKET_DESKTOP_END",h="SOCKET_USER_START",g="SOCKET_USER_END",E="SOCKET_PUSH_START",y="SOCKET_PUSH_END",k="SOCKET_JOIN_START",b=function(e,t){var n=t.type,r=t.payload;switch(n){case m:return f.connect(),void(e.status.connect=!0);case d:return f.disconnect(),void(e.status.connect=!1);case p:return void(e.status.deskTop=!0);case v:return void(e.status.deskTop=!1);case h:return void(e.status.user=!0);case g:return void(e.status.user=!1);case E:return e.socket.emit("create",r),void(e.status.push=!0);case y:return e.socket.emit("close",r),void(e.status.push=!1);case k:return void e.socket.emit("join",r);default:return e}},w={status:{connect:!1,deskTop:!1,user:!1,push:!1,faceDetector:!1},socket:f},C=(0,r.createContext)(null);const x=(0,r.memo)((function(){(0,u.T)();var e=(0,s.C)(b,w),t=(0,o.Z)(e,2),n=t[0],i=t[1];return(0,r.useEffect)((function(){return i({type:m}),function(){i({type:d})}}),[]),a().createElement(C.Provider,{value:{lookReducer:n,lookDispatch:i}},a().createElement(c.Outlet,null))}));var S=n(5861),N=n(7757),T=n.n(N),R=(n(1539),n(8674),n(7453)),O=(n(1249),function(e){var t=e.list;return a().createElement("div",{className:"grid grid-cols-3 gap-5"},t.map((function(e){var t=e.uid,n=void 0===t?"":t,r=e.title,o=void 0===r?"":r,s=e.banner,u=void 0===s?"":s,i=e.user,l=void 0===i?"":i;return a().createElement("div",{key:n},a().createElement(c.Link,{to:n},a().createElement("img",{className:"ui_aspect-ratio-16/9 cursor-pointer",loading:"lazy",src:u,alt:""})),a().createElement(c.Link,{to:n,className:"cursor-pointer"},o),a().createElement("div",null,a().createElement(c.Link,{to:"/user/".concat(n)},l)))})))});const D=(0,r.memo)(O),j=(0,r.memo)((function(){var e=(0,r.useState)(20),t=(0,o.Z)(e,2),n=(t[0],t[1],(0,r.useContext)(C)),s=(n.lookReducer.socket,n.lookDispatch,(0,r.useRef)(null)),u=(0,r.useRef)(null),i=(0,r.useState)([]),l=(0,o.Z)(i,2),f=(l[0],l[1],(0,R.useQuery)("look",(0,S.Z)(T().mark((function e(){var t,n;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("".concat("https://enigmatic-forest-38434.herokuapp.com","/list")).then((function(e){return e.json()}));case 2:return t=e.sent,n=t.data,e.abrupt("return",n);case 5:case"end":return e.stop()}}),e)}))))),m=f.data,d=void 0===m?[]:m;return f.error,f.isLoading,f.isSuccess,f.status,a().createElement("div",{className:"domLook overflow-auto max-h-full flex-auto",ref:s},a().createElement("div",{className:"domLook_header ui_header"},a().createElement("span",{className:"title h1"},"LOOK直播"),a().createElement("span",{className:"text-gray-400 slogan ml-2"},"在这里，看见音乐"),a().createElement(c.Link,{to:"my",className:"ml-2 py-1 px-2 rounded bg-red-500 text-white"},"我的直播"),a().createElement("a",{href:"https://look.163.com/hot",className:"text-gray-400 ml-auto"},"更多 >")),a().createElement("div",{className:"px-8"},a().createElement(D,{list:d}),a().createElement("div",{ref:u})))}));n(7042),n(8309),n(1038),n(8783),n(2526),n(1817),n(2165),n(6992),n(3948),n(2772),n(4916),n(4723),n(4747);var _=n(4184),A=n.n(_),I={iceServers:[{urls:["stun:stun.xten.com","stun:stun.services.mozilla.com","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}]};function L(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return P(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?P(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,c=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw c}}}}function P(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Z(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return K(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?K(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,c=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw c}}}}function K(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var F=function(e){var t=e.onClick,n=e.children,r=e.status;return a().createElement("button",{type:"button",className:A()("text-white rounded p-2",r?"bg-red-500":"bg-blue-500"),onClick:t},n)};const M=(0,r.memo)((function(){var e,t=(0,r.useContext)(C),n=t.lookReducer,c=n.status,s=(n.socket,t.lookDispatch),u=function(){var e=(0,r.useState)([]),t=(0,o.Z)(e,2),n=t[0],a=t[1],c=(0,r.useState)([]),s=(0,o.Z)(c,2),u=s[0],i=s[1];return(0,r.useEffect)((function(){(0,S.Z)(T().mark((function e(){var t,n,r,c,o,s;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,n=[],r=[],c=L(t);try{for(c.s();!(o=c.n()).done;)"audioinput"===(s=o.value).kind?n.push(s):"videoinput"===s.kind?r.push(s):console.log("other kind: ",s)}catch(e){c.e(e)}finally{c.f()}a(n),i(r);case 9:case"end":return e.stop()}}),e)})))()}),[]),{audioinput:n,videoinput:u}}(),i=u.audioinput,l=u.videoinput,f=(0,r.useRef)(null),m=(0,r.useRef)(null),d=(0,r.useRef)(null),k=(0,r.useRef)(null),b=(0,r.useRef)(null),w=(0,r.useRef)(null),x=(0,r.useRef)(null),N=(0,r.useRef)(null),R=(0,r.useRef)(new FaceDetector),O=((0,r.useRef)(((e=new RTCPeerConnection(I)).onicecandidate=function(e){e.target;var t=e.candidate;t&&new RTCIceCandidate(t)},e.onconnectionstatechange=function(t){e.connectionState},e.ondatachannel=function(e){console.log("Data channel is created!"),e.channel.onopen=function(){console.log("Data channel is open and ready to be used.")}},e.onicecandidateerror=function(e){e.errorCode>=300&&e.errorCode<=699||e.errorCode>=700&&e.errorCode},e.oniceconnectionstatechange=function(t){"failed"===e.iceConnectionState||"disconnected"===e.iceConnectionState||e.iceConnectionState},e.onicegatheringstatechange=function(){var t="Unknown";switch(e.iceGatheringState){case"new":case"complete":t="Idle";break;case"gathering":t="Determining route"}console.log(t)},e.onnegotiationneeded=function(){e.createOffer().then((function(t){return console.log("setLocalDescription"),e.setLocalDescription(t)})).then((function(){})).catch((function(e){return console.log(e)}))},e.onsignalingstatechange=function(t){e.signalingState},e)),function(){var e=(0,S.Z)(T().mark((function e(){var t,n;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=m.current,e.next=3,navigator.mediaDevices.getDisplayMedia({audio:!0,video:!0});case 3:n=e.sent,d.current=n,t.srcObject=n,n.getTracks()[0].onended=function(){s({type:v})},s({type:p});case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()),D=function(){var e=(0,S.Z)(T().mark((function e(){var t,n;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=f.current,e.next=3,navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720}}});case 3:n=e.sent,b.current=n,t.srcObject=n,s({type:h});case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),j=function(){var e=(0,S.Z)(T().mark((function e(){var t;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(t=f.current).srcObject.getTracks().forEach((function(e){return e.stop()})),t.srcObject=null,s({type:g});case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),_=function(){s({type:y,payload:{uid:"337845818"}})};(0,r.useEffect)((function(){return _}),[]);var A=function(e){var t=e.current;return function(e){var n=e.target,r=n.clientWidth,a=n.clientHeight;t.width=r,t.height=a}},P=function(){var e=(0,S.Z)(T().mark((function e(){var t,n,r,a,c,o,s,u;return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return requestAnimationFrame(P),t=k.current,n=x.current,r=t.width,a=t.height,e.next=6,R.current.detect(f.current).catch((function(e){return console.log(e)}));case 6:c=e.sent,n.clearRect(0,0,r,a),n.beginPath(),n.lineWidth=3,n.strokeStyle="lime",n.setLineDash([5]),o=Z(c);try{for(o.s();!(s=o.n()).done;)u=s.value.boundingBox,n.strokeRect(u.x,u.y,u.width,u.height)}catch(e){o.e(e)}finally{o.f()}case 14:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,r.useEffect)((function(){x.current=k.current.getContext("2d")}),[k]),(0,r.useEffect)((function(){N.current=w.current.getContext("2d")}),[w]),(0,r.useEffect)((function(){}),[d,b]),(0,r.useEffect)((function(){c.deskTop&&(console.log("mixin in"),N.current.drawImage(m.current,0,0))}),[c.deskTop]),a().createElement("div",{className:"w-full h-full p-8 overflow-auto"},a().createElement("div",{className:"flex"},a().createElement(F,{onClick:function(){if(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)return!1;var e;c.deskTop?((e=m.current).srcObject.getTracks().forEach((function(e){return e.stop()})),e.srcObject=null,s({type:v})):O()},status:c.deskTop},"桌面共享开关"),a().createElement(F,{onClick:D,status:c.user},"摄像头开"),a().createElement(F,{onClick:j,status:!c.user},"摄像头关"),a().createElement(F,{onClick:P,status:c.faceDetector},"人脸识别"),a().createElement(F,{onClick:function(){s({type:E,payload:{title:"6666",user:"337845818",uid:"337845818",banner:"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.jj20.com%2Fup%2Fallimg%2Ftp03%2F1Z9211616415M2-0-lp.jpg&refer=http%3A%2F%2Fimg.jj20.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1642140129&t=1cd7e5653b612ffbe71c1f461c5cb387",sdp:"this is sdp"}})},status:c.push},"推送"),a().createElement(F,{onClick:_,status:!c.push},"关闭推送")),a().createElement("div",{className:"flex"},a().createElement("span",null,"音频输入"),a().createElement("select",{className:"border"},i.map((function(e,t){return a().createElement("option",{value:"",key:t},e.label)}))),a().createElement("span",null,"视频输入"),a().createElement("select",{className:"border"},l.map((function(e,t){return a().createElement("option",{value:"",key:t},e.label)})))),a().createElement("div",{className:"flex flex-col"},a().createElement("div",{className:""},a().createElement("video",{className:"w-full",ref:m,autoPlay:!0,playsInline:!0,onLoadedMetadata:A(w)})),a().createElement("hr",null),a().createElement("div",{className:"relative"},a().createElement("video",{className:"w-full",ref:f,autoPlay:!0,playsInline:!0,style:{transform:"scale(-1, 1)"},onLoadedMetadata:A(k)}),a().createElement("canvas",{className:"absolute inset-0 w-full h-full",style:{transform:"scale(-1, 1)"},ref:k}))),a().createElement("hr",null),a().createElement("div",null,a().createElement("canvas",{className:"w-full",ref:w})))})),U=(0,r.memo)((function(){var e,t=(0,c.useParams)().uid,n=(0,r.useContext)(C),o=n.lookReducer,s=(o.status,o.socket),u=n.lookDispatch,i=((0,r.useRef)(((e=new RTCPeerConnection(I)).ontrack=function(e){return i.current.srcObject=e.streams[0]},e)),(0,r.useRef)(null)),l=function(){var e=(0,S.Z)(T().mark((function e(){return T().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i.current){e.next=2;break}return e.abrupt("return");case 2:u({type:k,payload:{uid:t}});case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return(0,r.useEffect)((function(){l()}),[]),(0,r.useEffect)((function(){var e=function(e){console.log("asd",e)};return s.on("join-success",e),function(){s.off("join-success",e)}}),[]),a().createElement("div",{className:"p-8 flex"},a().createElement("div",{className:"relative flex-1"},a().createElement("video",{ref:i,className:"w-full bg-black ui_aspect-ratio-16/9",autoPlay:!0,playsInline:!0}),a().createElement("video",{className:"absolute bottom-0 right-0 w-36 border m-4 ui_aspect-ratio-16/9",autoPlay:!0,playsInline:!0,muted:!0})),a().createElement("div",{className:"w-1/4 flex flex-col ml-2 border"},a().createElement("div",{className:"flex-1 overflow-auto"}),a().createElement("hr",null),a().createElement("div",{className:""},a().createElement("textarea",{className:"resize-none p-1 h-16 w-full block",placeholder:"say something"}))))})),z=function(){return a().createElement(c.Routes,null,a().createElement(c.Route,{element:a().createElement(x,null)},a().createElement(c.Route,{index:!0,element:a().createElement(j,null)}),a().createElement(c.Route,{path:"my",element:a().createElement(M,null)}),a().createElement(c.Route,{path:":uid",element:a().createElement(U,null)})))}}}]);
//# sourceMappingURL=Look.js.map?version=e9f6048f